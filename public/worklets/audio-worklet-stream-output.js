class Y{samples;channels;frameCount;constructor(q,D,G,H){this.samples=q.subarray(G*D,(G+H)*D),this.channels=D,this.frameCount=H}get(q,D){if(q<0||q>=this.frameCount||D<0||D>=this.channels)throw RangeError(`Frame or channel index is out of bounds: frame ${q}, channel ${D}`);return this.samples[q*this.channels+D]}set(q,D,G){if(q<0||q>=this.frameCount||D<0||D>=this.channels)throw RangeError(`Frame or channel index is out of bounds: frame ${q}, channel ${D}`);this.samples[q*this.channels+D]=G}}class Q{_buffer;_samplesPerFrame;frameCount;constructor(q){this._buffer=q.sampleBuffer,this._samplesPerFrame=q.samplesPerFrame,this.frameCount=Math.floor(this._buffer.length/this._samplesPerFrame)}enumFrameSegments(q,D,G){let H=0;while(H<D){let K=Math.min(this.frameCount-q,D-H),J=G(new Y(this._buffer,this._samplesPerFrame,q,K),H);if(J>K)throw RangeError(`Processed frames (${J}) exceeds segment frames (${K})`);if(H+=J,q=(q+J)%this.frameCount,J<K)break}return{totalProcessedFrames:H,nextFrameIndex:q}}}class W{_frameBuffer;_usedFramesInBuffer;_totalFrames;_frameIndex=0;constructor(q){this._frameBuffer=new Q(q),this._usedFramesInBuffer=q.usedFramesInBuffer,this._totalFrames=q.totalReadFrames}get availableFrames(){return Atomics.load(this._usedFramesInBuffer,0)}get totalFrames(){return this._totalFrames[0]}read(q){let D=this._frameBuffer.enumFrameSegments(this._frameIndex,this.availableFrames,q);return this._frameIndex=D.nextFrameIndex,Atomics.sub(this._usedFramesInBuffer,0,D.totalProcessedFrames),Atomics.add(this._totalFrames,0,BigInt(D.totalProcessedFrames)),D.totalProcessedFrames}}var k="@ain1084/audio-worklet-stream/output-stream-processor";class A extends AudioWorkletProcessor{_frameReader;_shouldStop=!1;_stopFramePosition;_underrunFrameCount=0;constructor(q){super();this._frameReader=new W(q.processorOptions),this.port.onmessage=this.handleMessage.bind(this)}handleMessage(q){if(q.data.type!=="stop")throw Error(`Unexpected message type: ${q.data.type}`);let D=q.data.framePosition;if(D<=0)this._shouldStop=!0;else this._stopFramePosition=D}updateUnderrun(q=0){if(q!==0){this._underrunFrameCount+=q;return}if(this._underrunFrameCount===0)return;this.port.postMessage({type:"underrun",underrunFrameCount:this._underrunFrameCount}),this._underrunFrameCount=0}checkStopCondition(q){if(this._stopFramePosition!==void 0&&q>=this._stopFramePosition)this._shouldStop=!0}process(q,D){let G=D[0],H=G.length,K=this._frameReader.read((Z,$)=>{let w=Z.frameCount,V=Math.min(w,G[0].length-$);return G.forEach((O,T)=>{for(let _=T,X=0;X<V;_+=H,++X)O[$+X]=Z.samples[_]}),V}),J=this._frameReader.totalFrames;if(this.checkStopCondition(J),this._shouldStop)return this.updateUnderrun(),this.port.postMessage({type:"stop",totalProcessedFrames:J}),this.port.close(),!1;let E=G[0].length-K;if(J!==BigInt(0))this.updateUnderrun(E);return!0}}registerProcessor(k,A);
